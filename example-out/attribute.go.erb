package main

import (
  "encoding/json"
  "errors"
  "fmt"
  "strconv"
  "time"

  "github.com/jackc/pgx"
)

const (
  Undefined = iota
  Null      = iota
  Present   = iota
)

<%
[
  ['Bool', 'bool'],
  ['Int16', 'int16'],
  ['Int32', 'int32'],
  ['Int64', 'int64'],
  ['String', 'string'],
  ['Time', 'time.Time'],
].each do |attr_type, value_type|
%>
type <%= attr_type %> struct {
  Value  <%= value_type %>
  Status byte
}

func (attr <%= attr_type %>) String() string {
  switch attr.Status {
  case Present:
    return fmt.Sprintf("%v", attr.Value)
  case Null:
    return "null"
  case Undefined:
    return "undefined"
  }

  panic("unreachable")
}

func (attr <%= attr_type %>) addUpdate(columnName string, sets *[]string, args *pgx.QueryArgs) {
  switch attr.Status {
    case Present:
      *sets = append(*sets, columnName+"="+args.Append(attr.Value))
    case Null:
      *sets = append(*sets, columnName+"="+args.Append(nil))
  }
}

func (attr <%= attr_type %>) addInsert(columnName string, sets, values *[]string, args *pgx.QueryArgs) {
  switch attr.Status {
    case Present:
      *sets = append(*sets, columnName)
      *values = append(*values, args.Append(attr.Value))
    case Null:
      *sets = append(*sets, columnName)
      *values = append(*values, args.Append(nil))
  }
}

func (attr *<%= attr_type %>) Scan(r *pgx.ValueReader) error {
  var nv pgx.Null<%= attr_type %>
  err := nv.Scan(r)
  if err != nil {
    return err
  }

  attr.Value = nv.<%= attr_type %>
  if nv.Valid {
    attr.Status = Present
  } else {
    attr.Status = Null
  }

  return nil
}


func (attr <%= attr_type %>) FormatCode() int16 {
  var nv pgx.Null<%= attr_type %>
  return nv.FormatCode()
}

func (attr <%= attr_type %>) Encode(w *pgx.WriteBuf, oid pgx.Oid) error {
  var nv pgx.Null<%= attr_type %>
  nv.<%= attr_type %> = attr.Value

  switch attr.Status {
  case Present:
    nv.Valid = true
  case Null:
    nv.Valid = false
  case Undefined:
    return errors.New("cannot encode undefined attr")
  }

  return nv.Encode(w, oid)
}
<% end %>

type Bytes struct {
  Value  []byte
  Status byte
}

func (attr *Bytes) addUpdate(columnName string, sets *[]string, args *pgx.QueryArgs) {
  switch attr.Status {
    case Present:
      *sets = append(*sets, columnName+"="+args.Append(attr.Value))
    case Null:
      *sets = append(*sets, columnName+"="+args.Append(nil))
  }
}

func (attr *Bytes) Scan(vr *pgx.ValueReader) error {
  if vr.Len() == -1 {
    attr.Value = nil
    attr.Status = Null
    return nil
  }

  attr.Value = vr.ReadBytes(vr.Len())
  attr.Status = Present
  return vr.Err()
}


func (attr Bytes) FormatCode() int16 {
  return pgx.BinaryFormatCode
}

func (attr Bytes) Encode(w *pgx.WriteBuf, oid pgx.Oid) error {
  if oid != pgx.ByteaOid {
    return pgx.SerializationError(fmt.Sprintf("Bytes.Encode cannot encode into OID %d", oid))
  }

  if attr.Status != Present {
    w.WriteInt32(-1)
    return nil
  }

  w.WriteBytes(attr.Value)
  return nil
}


func (attr Bool) MarshalJSON() ([]byte, error) {
  if attr.Status != Present {
    return []byte("null"), nil
  }
  if attr.Value {
    return []byte("true"), nil
  }
  return []byte("false"), nil
}

func (attr *Bool) UnmarshalJSON(bval []byte) error {
  sval := string(bval)

  switch sval {
  case "true":
    attr.Value = true
    attr.Status = Present
  case "false":
    attr.Value = false
    attr.Status = Present
  case "null":
    attr.Status = Null
  default:
    return errors.New("unknown Bool value")
  }

  return nil
}

<%
# MarshalJSON for integers
[
  ['Int16', 'int16', 16],
  ['Int32', 'int32', 32],
  ['Int64', 'int64', 64],
].each do |attr_type, go_type, bitCount|
%>
func (attr <%= attr_type%>) MarshalJSON() ([]byte, error) {
  if attr.Status != Present {
    return []byte("null"), nil
  }
  return []byte(strconv.FormatInt(int64(attr.Value), 10)), nil
}

func (attr *<%= attr_type%>) UnmarshalJSON(bval []byte) error {
  sval := string(bval)

  if sval == "null" {
    attr.Status = Null
    return nil
  }

  nval, err := strconv.ParseInt(sval, 10, <%= bitCount %>)
  if err != nil {
    return err
  }

  attr.Value = int<%=bitCount%>(nval)
  attr.Status = Present

  return nil
}
<% end %>

func (attr String) MarshalJSON() ([]byte, error) {
  if attr.Status != Present {
    return []byte("null"), nil
  }

  return json.Marshal(attr.Value)
}

func (attr *String) UnmarshalJSON(bval []byte) error {
  sval := string(bval)

  if sval == "null" {
    attr.Status = Null
    return nil
  }

  err := json.Unmarshal(bval, &attr.Value)
  if err != nil {
    return err
  }

  attr.Status = Present
  return nil
}
